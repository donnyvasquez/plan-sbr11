<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plan Saber 11 ‚Äì Checklist Pro (12 semanas)</title>
<meta name="description" content="Herramienta interactiva para organizar tu estudio del ICFES Saber 11. Guarda progreso, exporta datos y gu√≠a tu aprendizaje." />
<style>
  :root {
    --bg: #f8fafc;
    --fg: #1e293b;
    --muted: #64748b;
    --border: #e2e8f0;
    --primary: #2563eb;
    --primary-fg: #ffffff;
    --card-bg: #ffffff;
    --success: #10b981;
    --danger: #ef4444;
    --warn-bg: #fff7ed;
    --warn-border: #fdba74;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--fg);
    line-height: 1.5;
    overflow-x: hidden;
  }
  
  /* Layout & Header */
  header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 50;
    padding: 12px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
  .header-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
  h1 { font-size: 1.25rem; margin: 0; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 8px; }
  
  /* Controls */
  .controls { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn {
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--fg);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px;
    text-decoration: none; /* For links styled as btns */
  }
  .btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
  .btn-primary { background: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
  .btn-primary:hover { background: #1d4ed8; }
  
  /* Progress Bar */
  .progress-container { margin-top: 12px; }
  .bar-bg { height: 10px; background: #e2e8f0; border-radius: 99px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
  .stats-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
  .user-badge { color: var(--primary); font-weight: 600; margin-right: 8px; }

  /* Content Cards */
  main { padding: 24px 0; display: grid; gap: 20px; }
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .card h2, .card h3 { margin-top: 0; color: #0f172a; }
  .grid-2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media(min-width: 640px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  
  /* Resources Chips */
  .chip {
    display: flex; gap: 12px; align-items: start;
    padding: 12px; border: 1px solid var(--border);
    border-radius: 8px; background: #f8fafc;
  }
  .chip-icon { font-size: 1.2rem; background: #fff; padding: 6px; border-radius: 6px; border: 1px solid var(--border); }
  .chip-content { flex: 1; }
  .chip-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
  .chip-desc { font-size: 0.85rem; color: var(--muted); }
  .chip a { color: var(--primary); text-decoration: none; font-weight: 500; }
  .chip a:hover { text-decoration: underline; }

  /* Caja de Herramientas Highlight */
  .caja-herramientas {
    background: var(--warn-bg);
    border: 1px solid var(--warn-border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .caja-herramientas h3 { color: #c2410c; margin-top: 0; font-size: 1.1rem; }
  .caja-links { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .caja-link {
    background: white; border: 1px solid var(--warn-border); color: #c2410c;
    padding: 4px 10px; border-radius: 99px; text-decoration: none; font-size: 0.85rem; font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }
  .caja-link:hover { background: #fff7ed; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

  /* Week Checklist */
  #weeks-container { gap: 1rem; display: flex; flex-direction: column; }
  .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .week-title { font-size: 1.1rem; font-weight: 600; }
  .week-actions button { font-size: 0.75rem; padding: 4px 8px; }
  
  ul.task-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
  .task-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 8px; border-radius: 6px;
    transition: background 0.2s;
  }
  .task-item:hover { background: #f1f5f9; }
  .checkbox {
    appearance: none; width: 20px; height: 20px;
    border: 2px solid #cbd5e1; border-radius: 4px;
    background: #fff; cursor: pointer; flex-shrink: 0;
    position: relative; margin-top: 2px;
  }
  .checkbox:checked { background: var(--primary); border-color: var(--primary); }
  .checkbox:checked::after {
    content: '‚úì'; color: white; position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 14px; font-weight: bold;
  }
  .task-label { cursor: pointer; font-size: 0.95rem; color: #334155; }
  
  /* Resources per week */
  .week-resources {
    margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border);
    font-size: 0.9rem;
  }
  .week-resources-title { font-weight: 600; font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .res-link {
    display: inline-flex; align-items: center; gap: 6px;
    color: var(--primary); text-decoration: none; background: #eff6ff;
    padding: 4px 8px; border-radius: 4px; margin-right: 8px; margin-bottom: 8px;
    cursor: pointer;
  }
  .res-link:hover { background: #dbeafe; }

  .simulacro-box {
    margin-top: 12px; padding: 12px; background: #f0fdf4;
    border: 1px solid #bbf7d0; border-radius: 8px;
  }
  
  /* Toast */
  .toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: white; padding: 10px 20px; border-radius: 99px;
    font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100;
  }
  .toast.show { opacity: 1; }
  
  /* Modal Logic */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); z-index: 200;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  
  /* Standard Modal */
  .modal {
    background: white; padding: 24px; border-radius: 12px;
    max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    transform: scale(0.95); transition: transform 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .modal-overlay.open .modal { transform: scale(1); }
  
  /* Large Resource Modal (Full Screen-ish) */
  .modal.modal-lg {
    max-width: 1000px;
    width: 95%;
    height: 90vh; /* Alto casi completo */
    display: flex;
    flex-direction: column;
    padding: 0; /* Remove default padding for full content */
  }
  .modal-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
  }
  .modal-header h3 { margin: 0; font-size: 1rem; color: var(--fg); text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .modal-body {
    flex: 1;
    background: #e2e8f0;
    position: relative;
  }
  .modal-body iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }
  .modal-close {
    background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); margin-left: 12px;
  }
  
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  
  .input-group { margin: 16px 0; text-align: left; }
  .input-field { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; }

  /* Confetti Elements */
  .confetti {
    position: absolute; width: 10px; height: 10px;
    background: #f00; animation: fall linear forwards;
    z-index: 201; pointer-events: none;
  }
  @keyframes fall {
    to { transform: translateY(100vh) rotate(720deg); }
  }
  .celebration-emoji {
    font-size: 3rem; display: inline-block;
    animation: bounce 1s infinite alternate;
  }
  @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
  
  footer { text-align: center; color: var(--muted); font-size: 0.85rem; margin-top: 40px; padding-bottom: 20px; }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="header-row">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Plan Saber 11
      </h1>
      <div class="controls">
        <button class="btn" id="btn-reset">‚Ü∫ Reiniciar</button>
        <button class="btn" id="btn-export">‚¨áÔ∏è Guardar Archivo</button>
        <label class="btn btn-primary" style="cursor: pointer;">
          ‚¨ÜÔ∏è Cargar Archivo
          <input type="file" id="file-import" accept=".json" class="sr-only">
        </label>
      </div>
    </div>
    
    <div class="container progress-container" style="padding:0">
      <div class="bar-bg"><div id="bar-fill" class="bar-fill"></div></div>
      <div class="stats-row">
        <span id="txt-progress">0% completado</span>
        <div>
          <span id="user-badge" class="user-badge"></span>
          <span id="txt-saved">Estado: Listo</span>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  
  <!-- CAJA DE HERRAMIENTAS -->
  <section class="card caja-herramientas">
    <h3>üõ†Ô∏è Caja de Herramientas ICFES (Material Oficial)</h3>
    <p style="margin: 0 0 12px 0; font-size: 0.95rem; color: #4b5563;">
      Utiliza los <strong>Cuadernillos de Pr√°ctica</strong> para simular el examen y los <strong>Cuadernillos Explicados</strong> para entender tus errores. Haz clic para previsualizar.
    </p>
    <div class="caja-links" id="toolbar-links">
      <!-- Generated by JS -->
    </div>
  </section>

  <!-- RECURSOS GENERALES -->
  <section class="card">
    <h2 style="font-size: 1.25rem; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 16px;">üìö Otros Recursos Recomendados</h2>
    <div class="grid-2">
      <div class="chip">
        <div class="chip-icon">üßÆ</div>
        <div class="chip-content">
          <div class="chip-title">Matem√°ticas</div>
          <div class="chip-desc">
            Pr√°ctica: <a href="https://es.khanacademy.org/math" target="_blank">Khan Academy</a><br>
            YouTube: <a href="https://www.youtube.com/@ProfeAlex" target="_blank">Profe Alex</a> (B√°sico)
          </div>
        </div>
      </div>
      <div class="chip">
        <div class="chip-icon">üìñ</div>
        <div class="chip-content">
          <div class="chip-title">Lectura Cr√≠tica</div>
          <div class="chip-desc">
            Clave: Diferenciar texto continuo vs discontinuo.
          </div>
        </div>
      </div>
      <div class="chip">
        <div class="chip-icon">üß¨</div>
        <div class="chip-content">
          <div class="chip-title">Ciencias Naturales</div>
          <div class="chip-desc">
            Biolog√≠a/F√≠sica: <a href="https://pruebat.org/" target="_blank">Pru√©baT</a>
          </div>
        </div>
      </div>
      <div class="chip">
        <div class="chip-icon">‚öñÔ∏è</div>
        <div class="chip-content">
          <div class="chip-title">Sociales y Ciudadanas</div>
          <div class="chip-desc">
            <strong>Vital:</strong> Constituci√≥n Pol√≠tica 1991.
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="weeks-container"></div>
</main>

<footer>
  <p>El √©xito en el ICFES no es suerte, es disciplina.<br>Tus datos se guardan autom√°ticamente en este navegador.</p>
</footer>

<!-- MODALS -->
<div id="modal-welcome" class="modal-overlay">
  <div class="modal">
    <h2>üëã ¬°Hola! Bienvenido/a</h2>
    <p>Vamos a personalizar tu plan de estudio. ¬øC√≥mo te llamas?</p>
    <div class="input-group">
      <input type="text" id="input-name" class="input-field" placeholder="Tu nombre aqu√≠..." autocomplete="off">
    </div>
    <button class="btn btn-primary" id="btn-save-name" style="width:100%; justify-content:center">¬°Empezar!</button>
  </div>
</div>

<div id="modal-celebration" class="modal-overlay">
  <div class="modal" style="border-top: 5px solid var(--success);">
    <div class="celebration-emoji" id="cel-emoji">üéâ</div>
    <h2 id="cel-title">¬°Felicidades!</h2>
    <p id="cel-msg">Has alcanzado un hito importante.</p>
    <button class="btn btn-primary" onclick="closeCelebration()">¬°Vamos por m√°s!</button>
  </div>
</div>

<div id="modal-reset" class="modal-overlay">
  <div class="modal">
    <h3 style="margin-top:0">¬øReiniciar todo el plan?</h3>
    <p class="chip-desc" style="font-size:1rem">Se borrar√°n todos los checkboxes marcados. Esta acci√≥n no se puede deshacer.</p>
    <div class="modal-actions">
      <button class="btn" id="modal-cancel">Cancelar</button>
      <button class="btn" style="background: var(--danger); color: white; border: none;" id="modal-confirm">S√≠, reiniciar</button>
    </div>
  </div>
</div>

<!-- NUEVO: Modal Resource Viewer -->
<div id="modal-resource" class="modal-overlay">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3 id="res-title">Vista Previa</h3>
      <div>
        <a id="res-external-btn" href="#" target="_blank" class="btn" style="margin-right:8px; font-size:0.8rem">üîó Abrir en nueva pesta√±a</a>
        <button class="modal-close" id="res-close">√ó</button>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="res-frame" src="" title="Visor de documentos"></iframe>
    </div>
  </div>
</div>

<div id="toast" class="toast">Notificaci√≥n</div>

<script>
(function(){
  // --- CONFIG ---
  const STORAGE_KEY = 'saber11_pro_v3';
  
  // URLS CONSTANTES
  const URLS = {
    GUIA_2025: "https://www.icfes.gov.co/wp-content/uploads/2025/04/30-abril-guia-orientacion-saber-11o-2025-2.pdf",
    INFOGRAFIA: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/00_INFOGRAFIA_SABER_11.pdf",
    
    P_LECTURA: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/02_PRACTICA_LECTURA_CRITICA.pdf",
    E_LECTURA: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/01_EXPLICADAS_LECTURA_CRITICA.pdf",
    
    P_MATES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/04_PRACTICA_MATEMATICAS.pdf",
    E_MATES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/03_EXPLICADAS_MATEMATICAS.pdf",
    
    P_SOCIALES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/06_PRACTICA_SOCIALES_Y_CIUDADANAS.pdf",
    E_SOCIALES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/05_EXPLICADAS_SOCIALES_Y_CIUDADANAS.pdf",
    
    // UPDATED NATURALES LINKS (Removed _NATURALES suffix per user request)
    P_NATURALES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/08_PRACTICA_CIENCIAS.pdf",
    E_NATURALES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/07_EXPLICADAS_CIENCIAS.pdf",
    
    P_INGLES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/10_PRACTICA_INGLES.pdf",
    E_INGLES: "http://icfes.acendra.com.co/wp-content/uploads/2024/12/09_EXPLICADAS_INGLES.pdf"
  };

  let confettiInterval;
  
  // --- DATA PLAN ---
  const PLAN = [
    { id:'w0', title:'Semana 0: Diagn√≥stico Realista', tasks:[
      'Calificar simulacro y detectar materias d√©biles (<50%)',
      'Crear horario de estudio realista (m√≠nimo 1h diaria)',
      'Revisar estructura del examen en la web del ICFES',
      'Leer gu√≠a de orientaci√≥n Saber 11'
    ], simulacro: { ampm: true, label: 'Simulacro Diagn√≥stico #0 (L√≠nea Base)' },
      resources: [
        { text: 'üìò Gu√≠a de Orientaci√≥n 2025', url: URLS.GUIA_2025 },
        { text: 'üìä Infograf√≠a Saber 11', url: URLS.INFOGRAFIA }
      ]
    },
    { id:'w1', title:'Semana 1: Fundamentos Lectura y Matem√°ticas', tasks:[
      'Matem√°ticas: Regla de tres, porcentajes y fracciones',
      'Lectura: Identificar tesis y argumentos en textos de opini√≥n',
      'Sociales: Mecanismos de participaci√≥n (Tutela, Derecho de Petici√≥n)',
      'Repasar 30 verbos irregulares en Ingl√©s'
    ], resources: [
        { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES },
        { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
        { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES },
        { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES }
    ]},
    { id:'w2', title:'Semana 2: Ciencias y Geometr√≠a', tasks:[
      'Naturales: M√©todo cient√≠fico y an√°lisis de gr√°ficas experimentales',
      'Matem√°ticas: √Åreas, per√≠metros y vol√∫menes b√°sicos',
      'Lectura: Tipos de texto (narrativo, expositivo, argumentativo)',
      'Sociales: Ramas del poder p√∫blico en Colombia'
    ], simulacro: { ampm: true, label: 'Simulacro #1 (Primer Entrenamiento)' },
       resources: [
         { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
         { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES },
         { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
         { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES }
       ]
    },
    { id:'w3', title:'Semana 3: Qu√≠mica y Ciudadanas', tasks:[
      'Naturales (Qu√≠mica): Tabla peri√≥dica, enlaces y mezclas',
      'Sociales: Derechos fundamentales vs. Deberes',
      'Ingl√©s: Parte 1 (Avisos) y Parte 2 (Vocabulario)',
      'Matem√°ticas: Estad√≠stica b√°sica (Media, Mediana, Moda)'
    ], resources: [
        { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
        { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES },
        { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES },
        { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES }
    ]},
    { id:'w4', title:'Semana 4: F√≠sica y Textos Discontinuos', tasks:[
      'Naturales (F√≠sica): Cinem√°tica (movimiento) y Leyes de Newton',
      'Lectura: Infograf√≠as, tablas y caricaturas',
      'Matem√°ticas: Probabilidad simple',
      'Repaso de errores de las semanas 1-3'
    ], simulacro: { ampm: true, label: 'Simulacro #2 (Mitad de Camino)' },
       resources: [
         { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
         { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
         { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES }
       ]
    },
    { id:'w5', title:'Semana 5: Profundizaci√≥n Social', tasks:[
      'Sociales: Historia de Colombia (Frente Nacional, Constituci√≥n 91)',
      'Naturales: Ecosistemas y relaciones tr√≥ficas',
      'Ingl√©s: Parte 3 (Conversaciones) y Parte 4 (Textos con huecos)',
      'Matem√°ticas: √Ålgebra b√°sica y ecuaciones lineales'
    ], resources: [
        { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES },
        { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
        { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES },
        { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES }
    ]},
    { id:'w6', title:'Semana 6: Consolidaci√≥n', tasks:[
      'Revisi√≥n general de f√≥rmulas matem√°ticas',
      'Lectura: Lectura filos√≥fica (textos densos)',
      'Naturales: Reacciones qu√≠micas y estequiometr√≠a b√°sica',
      'Actualizar bit√°cora de errores'
    ], simulacro: { ampm: true, label: 'Simulacro #3 (Condiciones Reales)' },
       resources: [
         { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES },
         { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
         { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES }
       ]
    },
    { id:'w7', title:'Semana 7: F√≠sica II y Globalizaci√≥n', tasks:[
      'Naturales (F√≠sica): Energ√≠a, trabajo y ondas',
      'Sociales: Geograf√≠a humana y conflictos globales',
      'Ingl√©s: Parte 5 (Literal) y Parte 6 (Inferencial)',
      'Matem√°ticas: Trigonometr√≠a b√°sica (Seno, Coseno, Tri√°ngulos)'
    ], resources: [
        { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
        { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES },
        { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES },
        { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES }
    ]},
    { id:'w8', title:'Semana 8: Estrategia y Velocidad', tasks:[
      'Pr√°ctica de velocidad: 2 minutos por pregunta m√°ximo',
      'Lectura: Identificar intenci√≥n del autor y sesgos',
      'Naturales: CTS (Ciencia, Tecnolog√≠a y Sociedad)',
      'Sociales: Competencias ciudadanas (Convivencia y Paz)'
    ], simulacro: { ampm: true, label: 'Simulacro #4 (Resistencia)' },
       resources: [
         { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES },
         { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
         { text: 'üß¨ Naturales (Pr√°ctica)', url: URLS.P_NATURALES },
         { text: 'üåç Sociales (Pr√°ctica)', url: URLS.P_SOCIALES },
         { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES }
       ]
    },
    { id:'w9', title:'Semana 9: Recta Final - Bloques Duros', tasks:[
      'Bloque 1: 50 preguntas de Matem√°ticas seguidas',
      'Bloque 2: 50 preguntas de Lectura Cr√≠tica seguidas',
      'Revisi√≥n minuciosa de cada error cometido',
      'Ingl√©s: Parte 7 (Gram√°tica y vocabulario avanzado)'
    ], simulacro: { ampm: true, label: 'Simulacro #5 (El Definitivo)' },
       resources: [
         { text: 'üìê Matem√°ticas (Pr√°ctica)', url: URLS.P_MATES },
         { text: 'üìñ Lectura Cr√≠tica (Pr√°ctica)', url: URLS.P_LECTURA },
         { text: 'üá¨üáß Ingl√©s (Pr√°ctica)', url: URLS.P_INGLES }
       ]
    },
    { id:'w10', title:'Semana 10: Refuerzo de Debilidades (Explicadas)', tasks:[
      'Enfocarse SOLO en los temas con m√°s fallos del Simulacro #5',
      'No estudiar temas nuevos, consolidar lo que ya sabes',
      'Repasar Constituci√≥n Pol√≠tica (Art√≠culos clave)',
      'Matem√°ticas: Interpretaci√≥n de gr√°ficas complejas'
    ], resources: [
      { text: 'üí° Explicadas Matem√°ticas', url: URLS.E_MATES },
      { text: 'üí° Explicadas Lectura', url: URLS.E_LECTURA },
      { text: 'üí° Explicadas Sociales', url: URLS.E_SOCIALES },
      { text: 'üí° Explicadas Naturales', url: URLS.E_NATURALES },
      { text: 'üí° Explicadas Ingl√©s', url: URLS.E_INGLES }
    ]},
    { id:'w11', title:'Semana 11: Tapering (Bajar carga)', tasks:[
      'Lunes/Martes: Repaso ligero (f√≥rmulas, fechas clave)',
      'Mi√©rcoles: √öltima lectura en ingl√©s',
      'Jueves: Preparar documentos, l√°piz, borrador, transporte',
      'Viernes: DESCANSO TOTAL (Cero estudio)'
    ], simulacro: { label: '¬°D√≠a del Examen! Conf√≠a en tu proceso.' } }
  ];

  // --- STATE ---
  let state = {};

  // --- DOM ELEMENTS ---
  const container = document.getElementById('weeks-container');
  const barFill = document.getElementById('bar-fill');
  const txtProgress = document.getElementById('txt-progress');
  const txtSaved = document.getElementById('txt-saved');
  const userBadge = document.getElementById('user-badge');
  const toastEl = document.getElementById('toast');
  const toolbarLinks = document.getElementById('toolbar-links');
  
  const modalReset = document.getElementById('modal-reset');
  const modalWelcome = document.getElementById('modal-welcome');
  const modalCelebration = document.getElementById('modal-celebration');
  const modalResource = document.getElementById('modal-resource');
  
  // Resource Modal Elements
  const resTitle = document.getElementById('res-title');
  const resFrame = document.getElementById('res-frame');
  const resClose = document.getElementById('res-close');
  const resExtBtn = document.getElementById('res-external-btn');

  const btnReset = document.getElementById('btn-reset');
  const btnExport = document.getElementById('btn-export');
  const fileImport = document.getElementById('file-import');
  
  // Celebration elements
  const celEmoji = document.getElementById('cel-emoji');
  const celTitle = document.getElementById('cel-title');
  const celMsg = document.getElementById('cel-msg');

  // --- LOGIC ---
  function loadState() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      state = stored ? JSON.parse(stored) : {};
    } catch(e) { state = {}; }
    
    // Check Name presence
    if (!state.userName) {
      setTimeout(() => modalWelcome.classList.add('open'), 500);
    }
    // Initialize milestones trackers if missing
    if (typeof state.highestPercent === 'undefined') state.highestPercent = 0;
    if (!state.completedWeeks) state.completedWeeks = {};
  }

  function saveState(skipRender = false) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      txtSaved.textContent = 'Guardado ' + time;
      
      if(state.userName) {
        userBadge.textContent = 'Hola, ' + state.userName + ' | ';
      } else {
        userBadge.textContent = '';
      }

      if (!skipRender) renderWeeks();
    } catch(e) {
      showToast('Error al guardar localmente');
    }
  }

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 3000);
  }
  
  // --- RESOURCE MODAL LOGIC ---
  function openResource(url, title) {
    resTitle.textContent = title || 'Documento';
    resFrame.src = url;
    resExtBtn.href = url;
    modalResource.classList.add('open');
  }
  
  resClose.onclick = () => {
    modalResource.classList.remove('open');
    resFrame.src = ''; // Stop loading/playing
  };
  
  // --- CELEBRATION LOGIC ---
  function triggerCelebration(title, msg, emoji='üéâ') {
    celTitle.textContent = title;
    celMsg.innerHTML = msg; 
    celEmoji.textContent = emoji;
    modalCelebration.classList.add('open');
    startConfetti();
  }

  window.closeCelebration = function() {
    modalCelebration.classList.remove('open');
    stopConfetti();
  }

  function startConfetti() {
    if (confettiInterval) return;
    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
    confettiInterval = setInterval(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.background = colors[Math.floor(Math.random() * colors.length)];
      c.style.animationDuration = (Math.random() * 2 + 2) + 's'; 
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 4000);
    }, 100);
  }
  
  function stopConfetti() {
    clearInterval(confettiInterval);
    confettiInterval = null;
    document.querySelectorAll('.confetti').forEach(el => el.remove());
  }

  // --- CALCS & CHECKS ---
  function calculateProgress() {
    let total = 0;
    let done = 0;
    
    PLAN.forEach(week => {
      const wTasks = week.tasks.length;
      total += wTasks;
      if (state[week.id]) {
        state[week.id].tasks.forEach(t => { if(t) done++; });
      }
      
      if (week.simulacro && week.simulacro.ampm) {
        total += 2;
        if (state[week.id]?.simAM) done++;
        if (state[week.id]?.simPM) done++;
      }
    });
    
    return { done, total, percent: total === 0 ? 0 : Math.round((done/total)*100) };
  }
  
  function checkMilestones() {
    const progress = calculateProgress();
    const currentPercent = progress.percent;
    const name = state.userName || 'Estudiante';
    const lastHighest = state.highestPercent || 0;
    
    if (currentPercent > lastHighest) {
        const currentBracket = Math.floor(currentPercent / 10);
        const lastBracket = Math.floor(lastHighest / 10);
        
        state.highestPercent = currentPercent;

        if (currentBracket > lastBracket && currentBracket > 0) {
            triggerCelebration(
                `¬°Incre√≠ble, ${name}!`, 
                `Has alcanzado el <strong>${currentBracket * 10}%</strong> del plan. <br>¬°Est√°s imparable!`,
                'üöÄ'
            );
            return;
        }
    }
  }

  function checkWeeklyCompletion(weekId) {
    if (!state[weekId]) return;
    const weekPlan = PLAN.find(w => w.id === weekId);
    if (!weekPlan) return;

    const allTasksDone = weekPlan.tasks.every((_, idx) => state[weekId].tasks[idx] === true);
    let simDone = true;
    if (weekPlan.simulacro && weekPlan.simulacro.ampm) {
        if (!state[weekId].simAM || !state[weekId].simPM) simDone = false;
    }
    
    const isComplete = allTasksDone && simDone;
    const wasComplete = state.completedWeeks[weekId];

    if (isComplete && !wasComplete) {
        state.completedWeeks[weekId] = true;
        const name = state.userName || 'Campe√≥n/a';
        triggerCelebration(
            `¬°Semana completada!`,
            `¬°Excelente trabajo, <strong>${name}</strong>! <br>Has terminado todo lo planeado para la <em>${weekPlan.title.split(':')[0]}</em>.`,
            'üî•'
        );
    } else if (!isComplete) {
        state.completedWeeks[weekId] = false;
    }
  }

  // --- RENDER ---
  function renderToolbarLinks() {
    toolbarLinks.innerHTML = '';
    const mainLinks = [
      { t: 'üìê Matem√°ticas', u: URLS.P_MATES },
      { t: 'üìñ Lectura', u: URLS.P_LECTURA },
      { t: 'üåç Sociales', u: URLS.P_SOCIALES },
      { t: 'üß¨ Naturales', u: URLS.P_NATURALES },
      { t: 'üá¨üáß Ingl√©s', u: URLS.P_INGLES },
      { t: 'üìò Gu√≠a 2025', u: URLS.GUIA_2025, highlight: true }
    ];
    mainLinks.forEach(item => {
      const a = document.createElement('a');
      a.className = 'caja-link';
      a.textContent = item.t;
      if (item.highlight) { a.style.borderColor = '#2563eb'; a.style.color = '#2563eb'; }
      // Click handler for modal
      a.onclick = (e) => {
        e.preventDefault();
        openResource(item.u, item.t);
      };
      // Right click or ctrl click fallback
      a.href = item.u;
      a.target = '_blank';
      toolbarLinks.appendChild(a);
    });
  }

  function renderWeeks() {
    container.innerHTML = '';
    const progress = calculateProgress();
    
    if(state.userName) userBadge.textContent = 'Hola, ' + state.userName + ' | ';
    else userBadge.textContent = '';

    PLAN.forEach((week) => {
      if (!state[week.id]) state[week.id] = { tasks: [] };

      const card = document.createElement('section');
      card.className = 'card';
      
      const header = document.createElement('div');
      header.className = 'week-header';
      header.innerHTML = `<div class="week-title">${week.title}</div>`;
      
      const actions = document.createElement('div');
      actions.className = 'week-actions';
      
      const btnAll = document.createElement('button');
      btnAll.className = 'btn';
      btnAll.textContent = 'Todo';
      btnAll.onclick = () => toggleWeek(week.id, true, week.tasks.length);
      
      const btnNone = document.createElement('button');
      btnNone.className = 'btn';
      btnNone.textContent = 'Nada';
      btnNone.onclick = () => toggleWeek(week.id, false, week.tasks.length);
      
      actions.append(btnAll, btnNone);
      header.append(actions);
      card.appendChild(header);

      const ul = document.createElement('ul');
      ul.className = 'task-list';

      week.tasks.forEach((task, tIndex) => {
        const isDone = !!state[week.id].tasks[tIndex];
        const li = document.createElement('li');
        li.className = 'task-item';
        
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'checkbox';
        chk.checked = isDone;
        chk.id = `${week.id}-t${tIndex}`;
        chk.onchange = () => {
          state[week.id].tasks[tIndex] = chk.checked;
          afterChange(week.id);
        };

        const label = document.createElement('label');
        label.className = 'task-label';
        label.htmlFor = chk.id;
        label.textContent = task;

        li.append(chk, label);
        ul.appendChild(li);
      });
      card.appendChild(ul);

      // Resources
      if (week.resources && week.resources.length > 0) {
        const resDiv = document.createElement('div');
        resDiv.className = 'week-resources';
        resDiv.innerHTML = '<div class="week-resources-title">Material sugerido (Vista Previa disponible)</div>';
        week.resources.forEach(res => {
            const a = document.createElement('a');
            a.className = 'res-link';
            a.textContent = 'üîó ' + res.text;
            // Click Handler
            a.onclick = (e) => {
               e.preventDefault();
               openResource(res.url, res.text);
            };
            a.href = res.url; // Fallback
            a.target = '_blank';
            resDiv.appendChild(a);
        });
        card.appendChild(resDiv);
      }

      // Simulacro
      if (week.simulacro) {
        const simBox = document.createElement('div');
        simBox.className = 'simulacro-box';
        
        if (week.simulacro.ampm) {
          simBox.innerHTML = `<strong>${week.simulacro.label}</strong><div style="font-size:0.85rem; margin-bottom:8px">Condiciones reales (sin celular, tiempos exactos)</div>`;
          const grid = document.createElement('div');
          grid.className = 'grid-2';
          
          const createSimCheck = (key, labelText) => {
            const wrap = document.createElement('div');
            wrap.className = 'task-item';
            wrap.style.background = 'white';
            const sChk = document.createElement('input');
            sChk.type = 'checkbox';
            sChk.className = 'checkbox';
            sChk.checked = !!state[week.id][key];
            sChk.onchange = () => { state[week.id][key] = sChk.checked; afterChange(week.id); };
            const sLbl = document.createElement('span');
            sLbl.style.marginLeft = '8px';
            sLbl.textContent = labelText;
            wrap.append(sChk, sLbl);
            return wrap;
          };

          grid.append(createSimCheck('simAM', 'Sesi√≥n AM (4.5h)'), createSimCheck('simPM', 'Sesi√≥n PM (4.5h)'));
          simBox.appendChild(grid);
        } else {
          simBox.innerHTML = `üèÅ <strong>Hito:</strong> ${week.simulacro.label}`;
        }
        card.appendChild(simBox);
      }
      container.appendChild(card);
    });

    // Update UI Stats
    barFill.style.width = `${progress.percent}%`;
    txtProgress.textContent = `${progress.percent}% Completado (${progress.done}/${progress.total})`;
    if (progress.percent === 100) barFill.style.backgroundColor = '#10b981';
    else barFill.style.backgroundColor = 'var(--primary)';
  }

  function toggleWeek(weekId, status, count) {
    if (!state[weekId]) state[weekId] = { tasks: [] };
    for (let i = 0; i < count; i++) {
      state[weekId].tasks[i] = status;
    }
    const planWeek = PLAN.find(w => w.id === weekId);
    if (planWeek && planWeek.simulacro && planWeek.simulacro.ampm) {
      state[weekId].simAM = status;
      state[weekId].simPM = status;
    }
    afterChange(weekId);
  }
  
  function afterChange(weekId) {
    saveState(true); 
    checkWeeklyCompletion(weekId);
    checkMilestones();
    renderWeeks();
  }

  // --- HANDLERS ---
  document.getElementById('btn-save-name').onclick = () => {
    const nameInput = document.getElementById('input-name');
    const name = nameInput.value.trim();
    if (name) {
        state.userName = name;
        saveState();
        modalWelcome.classList.remove('open');
        showToast(`¬°Bienvenido/a al equipo, ${name}!`);
    } else {
        nameInput.style.borderColor = 'var(--danger)';
    }
  };

  btnReset.addEventListener('click', () => modalReset.classList.add('open'));
  document.getElementById('modal-cancel').addEventListener('click', () => modalReset.classList.remove('open'));
  document.getElementById('modal-confirm').addEventListener('click', () => {
    const oldName = state.userName; 
    state = {};
    if(oldName) state.userName = oldName;
    saveState();
    modalReset.classList.remove('open');
    showToast('Plan reiniciado');
    renderWeeks();
  });

  const downloadJSON = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state, null, 2));
    const a = document.createElement('a');
    a.href = dataStr;
    a.download = "saber11_" + (state.userName || 'plan') + "_" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a); a.click(); a.remove();
  };
  
  const handleImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const loadedState = JSON.parse(event.target.result);
        state = loadedState;
        saveState();
        if(!state.userName) { setTimeout(() => modalWelcome.classList.add('open'), 500); }
        showToast('Progreso importado');
        renderWeeks();
      } catch (err) { showToast('Archivo inv√°lido'); }
      e.target.value = '';
    };
    reader.readAsText(file);
  };

  btnExport.addEventListener('click', downloadJSON);
  fileImport.addEventListener('change', handleImport);

  // --- INIT ---
  loadState();
  renderToolbarLinks();
  renderWeeks();

})();
</script>
</body>
</html>
